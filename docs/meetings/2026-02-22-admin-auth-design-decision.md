# Issue #33 認証認可設計 合同ディスカッション議事録

## 保存先
`docs/meetings/2026-02-22-admin-auth-design-decision.md`

## 日時
2026-02-22

## 参加者
- 開発者（Dev_Aki）
- デザイナー（Design_Mio）
- テックリード（TL_Ren）
- PO（PO_Sora）

## ファシリテータ
テックリード

## 用語定義
- Issue #33: 管理者認証を短命・失効可能な方式へ移行するIssue。
- PR #72: デザイナーPR（管理者認証モックとhandoff）。
- AC: Issue本文の受け入れ条件。
- CP1-CP3: handoffで定義されたチェックポイント。

## アジェンダ
1. 認証方式とAPI契約の最終確定（ログイン入力・トークン更新有無・失効単位）
2. 401/403のUI状態と導線の統一（/admin と /admin/auth の責務分離を含む）
3. 実装着手前に即時反映する運用決定（Issue/PRへの記録内容）

## 議事録
<details>
  <summary>テックリード</summary>
  認証/認可は高リスク変更なので、論点を「方式」「UI状態」「運用記録」に分ける。比較案は必ず価値・リスク・工数・依存関係・検証方法で整理し、POが最終判断できる材料にする。既存実装が固定admin-token依存である点、PR #72がモックである点、Issueコメントでopaque token+30分固定が既に示されている点を会議前提に置く。
</details>

テックリード: まずアジェンダ1です。比較案はA案「Issueコメントどおり operatorId+password / 更新なし / 当該トークン失効のみ」と、B案「PR #72モック寄り email+password+OTP / 更新あり / 全失効+端末失効」です。A案の価値は仕様整合と実装の予測可能性、リスクはUX情報不足、工数は中、依存はAuth API実装、検証は401/403と期限切れE2E。B案の価値は運用UIが豊富、リスクはスコープ拡大、工数は大、依存は追加APIと監査保存、検証は大幅増になります。

<details>
  <summary>開発者</summary>
  既存コードでは固定admin-token照合とlocalStorage保存が残っており、B案に寄せるとバックエンド契約変更がさらに増える。まずA案で契約を固めないと実装とテストの切り替えが発散する。特にrefresh tokenを出すとサーバー状態管理と失効モデルが別Issue級になる。
</details>

開発者: A案を支持します。理由はIssue #33のACに直結し、固定トークン廃止・TTL30分固定・個別失効を最短で満たせるからです。B案の更新機能は価値はあるものの、リスクとして認証サーバの責務が増え、今回の工数とテスト範囲を超えます。

<details>
  <summary>デザイナー</summary>
  PR #72のモックは実装前合意のために情報量を多めに置いた。特に「更新」や「全失効」は運用者の不安を下げる意図だったが、仕様確定とズレるならUIコピーを調整すべき。反証として、operatorId入力はユーザーに分かりにくい可能性がある。
</details>

デザイナー: 条件付きでA案に賛成です。ただしログイン入力のラベルは「operatorId」そのままだと現場運用で迷うため、表示は「運用者ID（operatorId）」にしてほしいです。OTP欄は今回外して構いませんが、将来拡張余地はデザイン注記で残したいです。

<details>
  <summary>PO</summary>
  優先度は「漏えい影響の最小化」と「運用可能な失効」。価値判断として今回の完了条件はAC達成であり、拡張要件は別Issueに分離する方がスプリントの完了性が高い。反証ポイントは、UIが簡素化されすぎて運用に不安が出ないか。
</details>

PO: A案を第一候補にします。B案を今回採用しない理由は、価値は認めるが依存関係と工数が増えてAC達成時期が遅れるためです。更新機能と全失効は別Issue化を前提に切り分けます。

<details>
  <summary>テックリード</summary>
  ラウンド2では入力仕様と文言の最終境界を確定し、API契約の曖昧さを潰す。特に「表示名」と「送信フィールド名」を分離して混乱を避ける。
</details>

テックリード: ラウンド2です。A案採用前提で、入力UIは表示ラベルを運用者向けにしつつAPI送信は `operatorId` で固定、レスポンスは `accessToken/tokenType/operatorId/expiresAt` で確定してよいですか。加えてトークン更新ボタンは今回非表示で合意したいです。

<details>
  <summary>開発者</summary>
  フロントとバックの契約齟齬を防ぐため、フィールド名と表示名の分離は必須。更新ボタンを残すと「押せるのに未実装」になるリスクが高い。テスト観点はログイン成功、期限切れ401、失効401、権限不足403を必須にする。
</details>

開発者: 合意できます。API契約はIssueコメントの形で固定し、UIはラベルのみ運用者向けに調整します。更新機能は実装しないので関連文言とボタンは削除または非表示にします。

<details>
  <summary>デザイナー</summary>
  UI変更はモック差分で吸収可能。非採用案を残す場合は、画面上ではなくhandoffの「将来検討」に退避した方が誤解がない。401と403の文言トーンを統一しつつ、次行動CTAを分岐する必要がある。
</details>

デザイナー: 合意します。`Refresh token` 表示と「期限延長（更新）」ボタンは今回除外します。代わりに「残り有効時間」と「再ログイン導線」を主表示にします。

<details>
  <summary>PO</summary>
  受け入れ基準に対する判定可能性を確保するため、今会議で非採用案を明示しておく。将来拡張は否定ではなくスコープ管理であることを残す。
</details>

PO: アジェンダ1の結論としてA案を採用します。B案は価値はあるが今回の完了条件外のため不採用です。

<details>
  <summary>テックリード</summary>
  アジェンダ2はUI状態モデルとルート責務。比較案はC案「/admin/auth を新設し認証後に /admin へ遷移」とD案「/admin 単一画面で状態切替」。運用ガイドの責務分離原則と実装工数のトレードオフを扱う。
</details>

テックリード: アジェンダ2です。C案の価値は導線明確化と状態管理の単純化、リスクはルーティング改修、工数は中、依存は画面分割、検証はルート境界E2E。D案の価値は短期実装、リスクは状態混在、工数は小、依存は現状維持、検証は複雑化です。

<details>
  <summary>開発者</summary>
  現在はtoken文字列が入るだけで管理UIが見えるため、D案はセキュリティ誤認を誘発する。C案の方が「認証済み確定後のみ管理UI表示」を実装しやすい。反証として、既存導線との互換影響は確認が必要。
</details>

開発者: C案を推します。/admin/authで未認証・認証中・期限切れ・失効を扱い、/adminは認証済みのみ表示に分離した方が、401受信時の即時破棄と再認証遷移を実装しやすいです。

<details>
  <summary>デザイナー</summary>
  PR #72のtop barは `/admin/auth` 想定で作っており、C案との整合が高い。懸念は403時の位置づけで、認証済みだが権限不足の扱いをどちらの画面で出すか決める必要がある。
</details>

デザイナー: C案に賛成です。ただし403は `/admin` 側で「権限不足」を明示し、401とは別文言にしたいです。401は再ログイン、403は問い合わせまたは戻る導線に分けます。

<details>
  <summary>PO</summary>
  ユーザー価値として「次に何をすべきか」が明確なら導線分離は許容。リスクはリリース遅延なので、必要最低限の状態に絞るべき。6状態モデルのうち表示上の統合可否を確認したい。
</details>

PO: C案を採用寄りで考えますが、表示状態は必要最小限にしてください。実装上6状態を保持しても、画面では「再認証が必要」「権限不足」の2系統に整理できるならそれで良いです。

<details>
  <summary>テックリード</summary>
  ラウンド2で401/403のエラー契約とUI文言の対応表を確定する。ここが曖昧だとE2Eが不安定になる。
</details>

テックリード: ラウンド2です。401は `未認証/期限切れ/失効/不正トークン` をまとめて codeで区別、UIは再ログイン導線。403は権限不足で管理UI非表示。これを `/admin/auth` と `/admin` のどちらで見せるか最終確認したいです。

<details>
  <summary>開発者</summary>
  実装簡素化のため401はAPI応答時にtoken破棄して `/admin/auth` へ遷移する。403はtokenを保持しつつ `/admin` で拒否表示できる。検証はE2EでURL遷移とUI表示を固定する。
</details>

開発者: 合意です。401受信時は `sessionStorage` の管理者tokenを即時削除して `/admin/auth` へ戻す。403は `/admin` 内で専用パネル表示にします。

<details>
  <summary>デザイナー</summary>
  403画面のCTAは「参加者画面へ戻る」だけだと運用者が迷う場合がある。だが今回のスコープでは最小CTAに留めるのが妥当。文言差分はhandoffに追記する。
</details>

デザイナー: 合意します。401用文言は「再ログインする」、403用文言は「権限がありません。管理責任者に連絡してください」にし、403は戻り導線を維持します。

<details>
  <summary>PO</summary>
  判定基準に落とし込める表現へ簡約する。追加導線を増やしすぎると受け入れ判定が曖昧になる。
</details>

PO: アジェンダ2はC案採用で決定します。D案を採用しない理由は、短期工数は小さいが状態混在で誤認リスクが高く、認証認可Issueとして不適切だからです。

<details>
  <summary>テックリード</summary>
  アジェンダ3は会議後すぐ実行できる運用決定のみ扱う。比較案はE案「Issue #33へ決定事項を即時コメントし、PR #72へ差分確認コメントを残す」とF案「口頭合意のみで実装着手」。
</details>

テックリード: アジェンダ3です。E案の価値は追跡性、リスクは軽微、工数は小、依存はgh CLI、検証はコメントURL。F案は工数最小ですが、判断経緯が消えて再議論コストが上がります。

<details>
  <summary>開発者</summary>
  実装前に決定事項がIssueへ残っていないと、PRレビューで仕様解釈が割れる。特に非採用案の扱いは文章化が必要。反証としてコメント運用が冗長になる懸念はある。
</details>

開発者: E案支持です。Issue #33へ「採用案/非採用案/理由」をコメントし、実装PR冒頭で参照できる形にします。

<details>
  <summary>デザイナー</summary>
  PR #72は「未確定事項なし」と書いているため、今回の再確定を追記して齟齬をなくす必要がある。モック差分の責任範囲を明示しておきたい。
</details>

デザイナー: E案に賛成です。PR #72へ「更新UI除外」「失効単位調整」「入力項目調整」をコメントで明記します。

<details>
  <summary>PO</summary>
  PO観点では意思決定ログが最優先。F案は短期では速いが、次スプリント判断材料を失う。優先度管理上E案が妥当。
</details>

PO: E案を採用します。会議後すぐ記録し、Issueの受け入れ条件判定に使える状態にします。

<details>
  <summary>テックリード</summary>
  最終ラウンドで即時タスクの担当を固定する。長時間タスクはNext Actionに入れない。
</details>

テックリード: 最終確認です。即時アクションは「Issueコメント」「PR #72コメント」「実装開始前チェック項目の共有」の3点で閉じます。これで合意します。

<details>
  <summary>開発者</summary>
  実装作業そのものは即時アクションに含めない前提を確認。記録が完了したら実装着手できる。
</details>

開発者: 合意します。コメント投稿後にブランチ作業へ移ります。

<details>
  <summary>デザイナー</summary>
  handoff更新自体は別作業なので、今回はPRコメントで差分を先に通知する。
</details>

デザイナー: 合意します。モック差分はコメントで明確化します。

<details>
  <summary>PO</summary>
  POとしては受け入れ基準に照らした判断根拠が残ることを確認できた。
</details>

PO: 合意します。会議決定をIssueに反映した時点で、スコープ管理は成立です。

## 決定事項
- アジェンダ1: A案採用。`operatorId + password`、TTL30分固定、更新機能なし、失効は当該トークンのみ。
- アジェンダ2: C案採用。`/admin/auth` と `/admin` を分離し、401は再認証遷移、403は権限不足表示で分岐する。
- アジェンダ3: E案採用。会議後にIssue #33とPR #72へ決定事項を即時コメントし、非採用案と理由を追跡可能にする。
- 不採用理由の明記:
  - B案（更新・全失効・OTP同時導入）は価値はあるが、今回のAC達成に対して工数/依存が過大でスコープ外。
  - D案（/admin単一画面）は短期実装は容易だが、状態混在による誤認リスクが高い。
  - F案（口頭合意のみ）は工数最小だが、判断根拠が残らず再議論コストが増える。

## Next Action
- [ ] テックリード 会議決定サマリ（採用案・不採用案・理由）を Issue #33 にコメント投稿し、投稿URLを共有する。
- [ ] デザイナー PR #72 に「更新UI除外」「失効単位」「入力項目」の確定差分コメントを投稿する。
- [ ] 開発者 実装着手前チェックとして「API契約・401/403遷移・sessionStorage化」の3点を1コメントにまとめ、実装PRから参照できるよう Issue #33 へ返信する。
- [ ] PO Issue #33 コメントにて、本会議の決定を受け入れ基準判定の前提として承認する旨を1コメントで明記する。
