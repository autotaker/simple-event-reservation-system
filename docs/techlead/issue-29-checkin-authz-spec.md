# Issue #29 技術仕様書: チェックイン書き込み権限の厳格化

## 1. 目的

`/api/checkins` の書き込みAPIに対して、実行主体ルールを明文化し、実装で強制する。  
不正な主体によるチェックイン記録の作成を防止し、認可失敗時の挙動を統一する。

## 2. スコープ

### 対象
- `POST /api/checkins/event`
- `POST /api/checkins/sessions/{sessionId}`
- 上記2APIの認可判定、エラーハンドリング、テスト

### 非対象
- チェックインUIの見た目改善
- `GET /api/checkins` の仕様変更（回帰確認のみ）

## 3. 実行主体ルール

### 3.1 許可条件
- `ROLE_ADMIN`: 常に許可
- `ROLE_GUEST`: `Authentication.name == QR payload.guestId` の場合のみ許可（本人のみ）

### 3.2 拒否条件
- 未認証（認証ヘッダなし、またはトークン不正）
- `ROLE_GUEST` で本人不一致
- 想定外ロール

## 4. ステータスコードと責務

| 状態 | HTTP | 条件 |
|---|---:|---|
| 未認証/認証不正 | `401` | 認証情報なし、または無効トークン |
| 認証済みだが認可NG | `403` | 本人不一致、権限不足 |
| 業務ルール違反 | `400` | QR形式不正、対象セッション不一致、未予約 など |

## 5. API 挙動仕様

### 5.1 `POST /api/checkins/event`
1. 認証を解決する
2. 主体ルールを評価する
3. 許可時のみ既存 `checkInEvent` ロジックを実行する
4. 重複時は既存どおり `duplicate=true` を返却する

### 5.2 `POST /api/checkins/sessions/{sessionId}`
1. 認証を解決する
2. 主体ルールを評価する
3. 許可時のみ既存 `checkInSession` ロジックを実行する
4. 業務ルール違反は既存どおり `400` を返却する

## 6. 実装方針

### 6.1 認可ロジックの集約
- Controller に判定を分散させず、再利用可能なコンポーネントへ集約する
- 推奨: `checkin` パッケージ配下に認可ポリシークラスを追加する

### 6.2 例外の責務分離
- 認可違反は `403` を返せる例外として扱う
- 業務ルール違反（既存 `CheckInRuleViolationException`）は継続して `400`
- 未認証は Security 設定の責務として `401`

### 6.3 既存互換
- `ErrorResponse` のレスポンス形式は維持する
- 成功時レスポンス (`CheckInResponse`) のフィールドは変更しない

## 7. テスト仕様

### 7.1 正常系
- `ROLE_ADMIN` で event チェックイン成功
- `ROLE_ADMIN` で session チェックイン成功
- `ROLE_GUEST` 本人一致で event チェックイン成功
- `ROLE_GUEST` 本人一致で session チェックイン成功

### 7.2 異常系
- 未認証で `401`
- 不正トークンで `401`
- `ROLE_GUEST` 本人不一致で `403`
- QR形式不正/対象セッション不一致/未予約で `400`

### 7.3 回帰
- event/session の両経路で同一の主体ルールが適用される
- 重複チェックイン挙動（`duplicate`）が回帰しない
- `GET /api/checkins` が既存どおり動作する

## 8. 受け入れ基準（開発完了条件）

- 仕様どおりの主体ルールがコードで強制されている
- 仕様外主体の書き込みが `401`/`403` で拒否される
- 業務ルール違反が `400` で返る
- event/session 両経路で同一ルールを満たす自動テストが追加されている
